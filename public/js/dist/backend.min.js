$(document).ready(function () {
    var fadeSuccessMessages = function () {
        $(".alert-success").delay(2000).slideUp(500, function () {
            this.remove();
        });
    };
    /** Globaler Message Handler **/
        //AJAX-Response==JSON[msg]?set message
    $(document).ajaxSuccess(function (e, req) {
        if (req.responseJSON && req.responseJSON.msg) {
            var messages = req.responseJSON.msg;
            var messageTypes = {
                error: {
                    typeClass: "alert-danger",
                    title: "Fehler"
                },
                warning: {
                    typeClass: "alert-warning",
                    title: "Achtung"
                },
                success: {
                    typeClass: "alert-success",
                    title: "Erfolg"
                }
            };
            for (var type in messageTypes) {
                messages[type].forEach(function (msg) {
                    var htmlMsg = $('<div class="alert ' + messageTypes[type]["typeClass"] + ' alert-dismissible" role="alert">' +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span>' +
                    '</button>' +
                    '<strong>' + messageTypes[type]["title"] + '</strong> ' + msg +
                    '</div>').hide();
                    //Modal-Fenster?
                    var modal = $(".modal-dialog");
                    if (modal.length) {
                        modal.prepend(htmlMsg);
                    } else {
                        $("main").prepend(htmlMsg);
                    }
                    htmlMsg.slideDown(500);
                    //autofadeout vom erfolgsmeldungen
                    fadeSuccessMessages();
                });
            }
        }
    });
    /** Neue Frucht **/
    $(document).on("click", "#newFruitPhoto", function (e) {
        e.preventDefault();
        $("#fruitphoto").trigger("click");
    }).on("change", "#fruitphoto", function () {
        var data = new FormData();
        data.append($(this).attr("name"), this.files[0]);
        $(this).val(""); //IE-Bug

        var formular = $(this).parents("form");
        var targetUrl = formular.attr("action");

        $.ajax({
            url: targetUrl,
            data: data,
            cache: false,
            method: formular.attr("method"),
            contentType: false,
            processData: false,
            type: 'POST',
            success: function (data) {
                if (data.preview && data.token) {
                    $("#fruit_label").attr("src", "data:image/jpg;base64," + data["preview"]);
                    $("#token").val(data.token);
                }
            }
        });
    })
        //Leere Modal-Fenster nach Schließen
        .on("hidden.bs.modal", "#newFruit", function (e) {
            $(e.target).removeData('bs.modal');
        });

    //Lade Bild nicht nochmals hoch
    $('form#fruits').on("submit", function () {
        $(this).find('input[type="file"]').prop("disabled", true);
        return true;
    });

    //colorpicker
    $(function () {
        $('#fruits #color').colorpicker().on("changeColor", function (e) {
            var clr;
            if (e.color != undefined) {
                clr = e.color.toHex();
            } else {
                clr = $(this).val();

            }
            $(this).css({backgroundColor: clr});
        }).trigger("changeColor");
    });
    //confirm
    $('[data-toggle="confirmation"]').confirmation({
            title: "Sind Sie sicher?",
            singleton: true
        }
    );


    //Fadeout on load
    fadeSuccessMessages();
    /**
     * Funktionen für Wertevergleich
     * @returns {number}
     */
    Array.prototype.sum = function() {
        var count = 0;
        for(var i=0, n=this.length; i < n; i++) {
            count += this[i];
        }
        return count;
    };

    /**
     * Mixer-Darstellung/Steuerung
     */
    //wenn bild geladen => proportionen vorhanden
    $(window).load(function () {
        var img = $("#mixer");
        $('#mixerwrapper').css({
            width: img.width(),
            height: (img.height() / 2)
        });
    });

    var fruits=[]; //Sichert alle Früchte
    //Frücht hinzufügen
    /**
     * Initialisiert Slider
     */
    var initSliders=function(){
        //Slider
        $('.fruit-slider').slider({
            min:0,
            max:100,
            step:1,
            value:0,
            tooltip: "hide",
            handle: "round"
        }).on("slide", function(e) {
            var id=$(this).attr("data-prev");
            $("#"+id).text(e.value);
            $(this).val(e.value);
            adjustSum($(this));
        });
    };
    /**
     * Liefert Regler mit größtem Wert
     * @returns {*}
     */
    var getBiggestSlider=function(){
        var biggest;
        var biggestVal=0;

        var changingSlider=undefined;
        if(arguments.length>0) {
            changingSlider = arguments[0];
        }

        $(".fruit-slider").each(function(i,e){
            var newVal=$(e).data("slider").getValue();
            if(changingSlider==undefined){
                if(biggestVal<newVal){
                    biggest=$(e);
                    biggestVal=newVal;
                }
            }else{
                if(biggestVal<newVal && $(e).attr("data-prev")!=changingSlider.attr("data-prev")){
                    biggest=$(e);
                    biggestVal=newVal;
                }
            }
        });
        return biggest;
    };
    /**
     * Berechne Preis
     */
    var calcPrice=function(){
        var summeEle=$("#summe");
        var summe=0;
        var sizeSelect=$('#size').find('option[value="'+$('#size').val()+'"]').text();
        var size=parseInt(/[A-Z] \((.+)ml\)/.exec(sizeSelect)[1]);

        $(".fruit-slider").each(function(i,e){
            var amount=$(e).data("slider").getValue();
            var fruitPrice=parseFloat($(e).attr("data-price"));
            summe+=(amount*size*fruitPrice)/10000;
        });
        summeEle.text(summe.toFixed(2).replace(".",","))
    };
    /**
     * Aktualisiert den Mixer
     */
    var drawMixer=function(){
        //Entferne alles
        var wrapper=$("#mixerwrapper");
        wrapper.find("> .fruitcolor").remove();
        var amounts=[];
        var colors={};

        var fruitColorTmpl=$('<div class="fruitcolor"><div class="fruitwave"></div><div class="fruitbody"></div></div>');

        $(".fruit-slider").each(function(i,e){
            var amount=$(e).data("slider").getValue();
            if(amount>0) {
                //Kunstgriff. veringere Werte um mit identischen Werten Farben speichern zu können
                while(amounts.indexOf(amount)!=-1){
                    amount--;
                }
                amounts.push(amount);
                colors[amount] = $(e).attr("data-color");
            }
        });
        amounts.sort().reverse();

        var amountsSum=0;
        amounts.forEach(function(e){

            amountsSum+=e;
            var newEle=fruitColorTmpl.clone();
            newEle.css("height",amountsSum*0.77+"%");
            newEle.find(">*").css("backgroundColor",colors[e]);
            //entferne Farbwert um keine do
            wrapper.prepend(newEle);
        })
    };
    /**
     * Stellt sicher, dass alle Regler immer 100% ergeben!
     */
    var adjustSum=function(){
        var values=[];
        $(".fruit-slider").each(function(i,e){
            values.push($(e).data("slider").getValue());
        });
        var changingSlider=undefined;
        if(arguments.length>0) {
            changingSlider = arguments[0];
        }
        var sum=values.sum();
        if(sum>100){
            var diff=sum-100;
            var biggest=getBiggestSlider(changingSlider);
            var val=biggest.data("slider").getValue();
            biggest.data("slider").setValue(val-diff);
            biggest.val(val-diff);
            $('#'+$(biggest).attr("data-prev")).text(val-diff);
        }
        calcPrice();
        drawMixer();
    };
    /**
     * Fügt Frucht in Formular ein
     */
    var addFruit=function(id,color,name,price,pic){
        if(id==undefined){
            return
        }

        var defaultValue=$("#all-fruit-sliders>*").length<1?100:0;

        var slideTmpl=$('<div class="row fruit-slide-row" data-fruit-id="'+id+'">' +
        '<img src="'+pic+'"/>' +
        '<label><span id="fruit'+id+'" class="fruit-value">'+defaultValue+'</span>'+name+'</label><br>' +
        '<input name="fruitInSmoothie['+id+']" type="text" data-color="'+color+'" data-price="'+price+'" class="fruit-slider" data-prev="fruit'+id+'" data-slider-value="'+defaultValue+'" />' +
        '<button class="btn btn-danger remove-fruit" >' +
        '<span class="glyphicon glyphicon-remove" aria-hidden="true"></button></div>');

        //füge ein
        $("#all-fruit-sliders").append(slideTmpl);

        $(".fruit-slider").val(defaultValue);
        initSliders();
        adjustSum();
        
        $('[data-prev="fruit'+id+'"]')
            .parents(".slider")
            .find(".slider-selection, .slider-handle")
            .css("background",color);


    };

    $("#btn-add-fruit").on("click",function(){
        var modalWindow=$('.insertnewFruit');
        var ID=modalWindow.find("select").val();
        var selection=modalWindow.find('option[id="'+ID+'"]');
        var color=selection.attr("data-color");
        var pic=selection.attr("data-pic");
        var name=selection.attr("data-name");
        var price=selection.attr("data-price");
        addFruit(ID,color,name,price, pic);
        //Auswahl steht nicht mehr zur Verfügung
        selection.prop("disabled","disabled");
        modalWindow.find("select").selectpicker('render');

        modalWindow.modal('hide')
    });

    /**
     * Löscht eine Frucht
     */
    $(document).on("click",".remove-fruit",function(e){
        e.preventDefault();
        var row=$(this).parents(".fruit-slide-row");
        var ID=row.attr("data-fruit-id");
        var modalWindow=$('.insertnewFruit');

        modalWindow.find('option[id="'+ID+'"]').removeAttr("disabled");
        modalWindow.find("select").selectpicker('render');
        $(this).parents(".fruit-slide-row").remove();
        adjustSum();
    });

    //Wenn sich Preis ändert..
    $("#size").on("change", calcPrice);

    $(window).load(function(){ //erst nach laden der Bilder
        initSliders();
        //ermaliges einfügen einer Frucht
        $('.insertnewFruit').modal('show')
    });

});


//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZC5taW4uanMiLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJiYWNrZW5kLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgZmFkZVN1Y2Nlc3NNZXNzYWdlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJChcIi5hbGVydC1zdWNjZXNzXCIpLmRlbGF5KDIwMDApLnNsaWRlVXAoNTAwLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZSgpO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIC8qKiBHbG9iYWxlciBNZXNzYWdlIEhhbmRsZXIgKiovXG4gICAgICAgIC8vQUpBWC1SZXNwb25zZT09SlNPTlttc2ddP3NldCBtZXNzYWdlXG4gICAgJChkb2N1bWVudCkuYWpheFN1Y2Nlc3MoZnVuY3Rpb24gKGUsIHJlcSkge1xuICAgICAgICBpZiAocmVxLnJlc3BvbnNlSlNPTiAmJiByZXEucmVzcG9uc2VKU09OLm1zZykge1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2VzID0gcmVxLnJlc3BvbnNlSlNPTi5tc2c7XG4gICAgICAgICAgICB2YXIgbWVzc2FnZVR5cGVzID0ge1xuICAgICAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVDbGFzczogXCJhbGVydC1kYW5nZXJcIixcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiRmVobGVyXCJcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHdhcm5pbmc6IHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZUNsYXNzOiBcImFsZXJ0LXdhcm5pbmdcIixcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IFwiQWNodHVuZ1wiXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVDbGFzczogXCJhbGVydC1zdWNjZXNzXCIsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBcIkVyZm9sZ1wiXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGZvciAodmFyIHR5cGUgaW4gbWVzc2FnZVR5cGVzKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZXNbdHlwZV0uZm9yRWFjaChmdW5jdGlvbiAobXNnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBodG1sTXNnID0gJCgnPGRpdiBjbGFzcz1cImFsZXJ0ICcgKyBtZXNzYWdlVHlwZXNbdHlwZV1bXCJ0eXBlQ2xhc3NcIl0gKyAnIGFsZXJ0LWRpc21pc3NpYmxlXCIgcm9sZT1cImFsZXJ0XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cImNsb3NlXCIgZGF0YS1kaXNtaXNzPVwiYWxlcnRcIiBhcmlhLWxhYmVsPVwiQ2xvc2VcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGFyaWEtaGlkZGVuPVwidHJ1ZVwiPiZ0aW1lczs8L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2J1dHRvbj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzdHJvbmc+JyArIG1lc3NhZ2VUeXBlc1t0eXBlXVtcInRpdGxlXCJdICsgJzwvc3Ryb25nPiAnICsgbXNnICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgLy9Nb2RhbC1GZW5zdGVyP1xuICAgICAgICAgICAgICAgICAgICB2YXIgbW9kYWwgPSAkKFwiLm1vZGFsLWRpYWxvZ1wiKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwucHJlcGVuZChodG1sTXNnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoXCJtYWluXCIpLnByZXBlbmQoaHRtbE1zZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaHRtbE1zZy5zbGlkZURvd24oNTAwKTtcbiAgICAgICAgICAgICAgICAgICAgLy9hdXRvZmFkZW91dCB2b20gZXJmb2xnc21lbGR1bmdlblxuICAgICAgICAgICAgICAgICAgICBmYWRlU3VjY2Vzc01lc3NhZ2VzKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICAvKiogTmV1ZSBGcnVjaHQgKiovXG4gICAgJChkb2N1bWVudCkub24oXCJjbGlja1wiLCBcIiNuZXdGcnVpdFBob3RvXCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgJChcIiNmcnVpdHBob3RvXCIpLnRyaWdnZXIoXCJjbGlja1wiKTtcbiAgICB9KS5vbihcImNoYW5nZVwiLCBcIiNmcnVpdHBob3RvXCIsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZGF0YS5hcHBlbmQoJCh0aGlzKS5hdHRyKFwibmFtZVwiKSwgdGhpcy5maWxlc1swXSk7XG4gICAgICAgICQodGhpcykudmFsKFwiXCIpOyAvL0lFLUJ1Z1xuXG4gICAgICAgIHZhciBmb3JtdWxhciA9ICQodGhpcykucGFyZW50cyhcImZvcm1cIik7XG4gICAgICAgIHZhciB0YXJnZXRVcmwgPSBmb3JtdWxhci5hdHRyKFwiYWN0aW9uXCIpO1xuXG4gICAgICAgICQuYWpheCh7XG4gICAgICAgICAgICB1cmw6IHRhcmdldFVybCxcbiAgICAgICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgICAgICBjYWNoZTogZmFsc2UsXG4gICAgICAgICAgICBtZXRob2Q6IGZvcm11bGFyLmF0dHIoXCJtZXRob2RcIiksXG4gICAgICAgICAgICBjb250ZW50VHlwZTogZmFsc2UsXG4gICAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsXG4gICAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhLnByZXZpZXcgJiYgZGF0YS50b2tlbikge1xuICAgICAgICAgICAgICAgICAgICAkKFwiI2ZydWl0X2xhYmVsXCIpLmF0dHIoXCJzcmNcIiwgXCJkYXRhOmltYWdlL2pwZztiYXNlNjQsXCIgKyBkYXRhW1wicHJldmlld1wiXSk7XG4gICAgICAgICAgICAgICAgICAgICQoXCIjdG9rZW5cIikudmFsKGRhdGEudG9rZW4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSlcbiAgICAgICAgLy9MZWVyZSBNb2RhbC1GZW5zdGVyIG5hY2ggU2NobGllw59lblxuICAgICAgICAub24oXCJoaWRkZW4uYnMubW9kYWxcIiwgXCIjbmV3RnJ1aXRcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICQoZS50YXJnZXQpLnJlbW92ZURhdGEoJ2JzLm1vZGFsJyk7XG4gICAgICAgIH0pO1xuXG4gICAgLy9MYWRlIEJpbGQgbmljaHQgbm9jaG1hbHMgaG9jaFxuICAgICQoJ2Zvcm0jZnJ1aXRzJykub24oXCJzdWJtaXRcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAkKHRoaXMpLmZpbmQoJ2lucHV0W3R5cGU9XCJmaWxlXCJdJykucHJvcChcImRpc2FibGVkXCIsIHRydWUpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KTtcblxuICAgIC8vY29sb3JwaWNrZXJcbiAgICAkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgJCgnI2ZydWl0cyAjY29sb3InKS5jb2xvcnBpY2tlcigpLm9uKFwiY2hhbmdlQ29sb3JcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIHZhciBjbHI7XG4gICAgICAgICAgICBpZiAoZS5jb2xvciAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBjbHIgPSBlLmNvbG9yLnRvSGV4KCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNsciA9ICQodGhpcykudmFsKCk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQodGhpcykuY3NzKHtiYWNrZ3JvdW5kQ29sb3I6IGNscn0pO1xuICAgICAgICB9KS50cmlnZ2VyKFwiY2hhbmdlQ29sb3JcIik7XG4gICAgfSk7XG4gICAgLy9jb25maXJtXG4gICAgJCgnW2RhdGEtdG9nZ2xlPVwiY29uZmlybWF0aW9uXCJdJykuY29uZmlybWF0aW9uKHtcbiAgICAgICAgICAgIHRpdGxlOiBcIlNpbmQgU2llIHNpY2hlcj9cIixcbiAgICAgICAgICAgIHNpbmdsZXRvbjogdHJ1ZVxuICAgICAgICB9XG4gICAgKTtcblxuXG4gICAgLy9GYWRlb3V0IG9uIGxvYWRcbiAgICBmYWRlU3VjY2Vzc01lc3NhZ2VzKCk7XG4gICAgLyoqXG4gICAgICogRnVua3Rpb25lbiBmw7xyIFdlcnRldmVyZ2xlaWNoXG4gICAgICogQHJldHVybnMge251bWJlcn1cbiAgICAgKi9cbiAgICBBcnJheS5wcm90b3R5cGUuc3VtID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBjb3VudCA9IDA7XG4gICAgICAgIGZvcih2YXIgaT0wLCBuPXRoaXMubGVuZ3RoOyBpIDwgbjsgaSsrKSB7XG4gICAgICAgICAgICBjb3VudCArPSB0aGlzW2ldO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb3VudDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogTWl4ZXItRGFyc3RlbGx1bmcvU3RldWVydW5nXG4gICAgICovXG4gICAgLy93ZW5uIGJpbGQgZ2VsYWRlbiA9PiBwcm9wb3J0aW9uZW4gdm9yaGFuZGVuXG4gICAgJCh3aW5kb3cpLmxvYWQoZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgaW1nID0gJChcIiNtaXhlclwiKTtcbiAgICAgICAgJCgnI21peGVyd3JhcHBlcicpLmNzcyh7XG4gICAgICAgICAgICB3aWR0aDogaW1nLndpZHRoKCksXG4gICAgICAgICAgICBoZWlnaHQ6IChpbWcuaGVpZ2h0KCkgLyAyKVxuICAgICAgICB9KTtcbiAgICB9KTtcblxuICAgIHZhciBmcnVpdHM9W107IC8vU2ljaGVydCBhbGxlIEZyw7xjaHRlXG4gICAgLy9GcsO8Y2h0IGhpbnp1ZsO8Z2VuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGlzaWVydCBTbGlkZXJcbiAgICAgKi9cbiAgICB2YXIgaW5pdFNsaWRlcnM9ZnVuY3Rpb24oKXtcbiAgICAgICAgLy9TbGlkZXJcbiAgICAgICAgJCgnLmZydWl0LXNsaWRlcicpLnNsaWRlcih7XG4gICAgICAgICAgICBtaW46MCxcbiAgICAgICAgICAgIG1heDoxMDAsXG4gICAgICAgICAgICBzdGVwOjEsXG4gICAgICAgICAgICB2YWx1ZTowLFxuICAgICAgICAgICAgdG9vbHRpcDogXCJoaWRlXCIsXG4gICAgICAgICAgICBoYW5kbGU6IFwicm91bmRcIlxuICAgICAgICB9KS5vbihcInNsaWRlXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHZhciBpZD0kKHRoaXMpLmF0dHIoXCJkYXRhLXByZXZcIik7XG4gICAgICAgICAgICAkKFwiI1wiK2lkKS50ZXh0KGUudmFsdWUpO1xuICAgICAgICAgICAgJCh0aGlzKS52YWwoZS52YWx1ZSk7XG4gICAgICAgICAgICBhZGp1c3RTdW0oJCh0aGlzKSk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgLyoqXG4gICAgICogTGllZmVydCBSZWdsZXIgbWl0IGdyw7bDn3RlbSBXZXJ0XG4gICAgICogQHJldHVybnMgeyp9XG4gICAgICovXG4gICAgdmFyIGdldEJpZ2dlc3RTbGlkZXI9ZnVuY3Rpb24oKXtcbiAgICAgICAgdmFyIGJpZ2dlc3Q7XG4gICAgICAgIHZhciBiaWdnZXN0VmFsPTA7XG5cbiAgICAgICAgdmFyIGNoYW5naW5nU2xpZGVyPXVuZGVmaW5lZDtcbiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aD4wKSB7XG4gICAgICAgICAgICBjaGFuZ2luZ1NsaWRlciA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgfVxuXG4gICAgICAgICQoXCIuZnJ1aXQtc2xpZGVyXCIpLmVhY2goZnVuY3Rpb24oaSxlKXtcbiAgICAgICAgICAgIHZhciBuZXdWYWw9JChlKS5kYXRhKFwic2xpZGVyXCIpLmdldFZhbHVlKCk7XG4gICAgICAgICAgICBpZihjaGFuZ2luZ1NsaWRlcj09dW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICBpZihiaWdnZXN0VmFsPG5ld1ZhbCl7XG4gICAgICAgICAgICAgICAgICAgIGJpZ2dlc3Q9JChlKTtcbiAgICAgICAgICAgICAgICAgICAgYmlnZ2VzdFZhbD1uZXdWYWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICAgICAgaWYoYmlnZ2VzdFZhbDxuZXdWYWwgJiYgJChlKS5hdHRyKFwiZGF0YS1wcmV2XCIpIT1jaGFuZ2luZ1NsaWRlci5hdHRyKFwiZGF0YS1wcmV2XCIpKXtcbiAgICAgICAgICAgICAgICAgICAgYmlnZ2VzdD0kKGUpO1xuICAgICAgICAgICAgICAgICAgICBiaWdnZXN0VmFsPW5ld1ZhbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gYmlnZ2VzdDtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEJlcmVjaG5lIFByZWlzXG4gICAgICovXG4gICAgdmFyIGNhbGNQcmljZT1mdW5jdGlvbigpe1xuICAgICAgICB2YXIgc3VtbWVFbGU9JChcIiNzdW1tZVwiKTtcbiAgICAgICAgdmFyIHN1bW1lPTA7XG4gICAgICAgIHZhciBzaXplU2VsZWN0PSQoJyNzaXplJykuZmluZCgnb3B0aW9uW3ZhbHVlPVwiJyskKCcjc2l6ZScpLnZhbCgpKydcIl0nKS50ZXh0KCk7XG4gICAgICAgIHZhciBzaXplPXBhcnNlSW50KC9bQS1aXSBcXCgoLispbWxcXCkvLmV4ZWMoc2l6ZVNlbGVjdClbMV0pO1xuXG4gICAgICAgICQoXCIuZnJ1aXQtc2xpZGVyXCIpLmVhY2goZnVuY3Rpb24oaSxlKXtcbiAgICAgICAgICAgIHZhciBhbW91bnQ9JChlKS5kYXRhKFwic2xpZGVyXCIpLmdldFZhbHVlKCk7XG4gICAgICAgICAgICB2YXIgZnJ1aXRQcmljZT1wYXJzZUZsb2F0KCQoZSkuYXR0cihcImRhdGEtcHJpY2VcIikpO1xuICAgICAgICAgICAgc3VtbWUrPShhbW91bnQqc2l6ZSpmcnVpdFByaWNlKS8xMDAwMDtcbiAgICAgICAgfSk7XG4gICAgICAgIHN1bW1lRWxlLnRleHQoc3VtbWUudG9GaXhlZCgyKS5yZXBsYWNlKFwiLlwiLFwiLFwiKSlcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEFrdHVhbGlzaWVydCBkZW4gTWl4ZXJcbiAgICAgKi9cbiAgICB2YXIgZHJhd01peGVyPWZ1bmN0aW9uKCl7XG4gICAgICAgIC8vRW50ZmVybmUgYWxsZXNcbiAgICAgICAgdmFyIHdyYXBwZXI9JChcIiNtaXhlcndyYXBwZXJcIik7XG4gICAgICAgIHdyYXBwZXIuZmluZChcIj4gLmZydWl0Y29sb3JcIikucmVtb3ZlKCk7XG4gICAgICAgIHZhciBhbW91bnRzPVtdO1xuICAgICAgICB2YXIgY29sb3JzPXt9O1xuXG4gICAgICAgIHZhciBmcnVpdENvbG9yVG1wbD0kKCc8ZGl2IGNsYXNzPVwiZnJ1aXRjb2xvclwiPjxkaXYgY2xhc3M9XCJmcnVpdHdhdmVcIj48L2Rpdj48ZGl2IGNsYXNzPVwiZnJ1aXRib2R5XCI+PC9kaXY+PC9kaXY+Jyk7XG5cbiAgICAgICAgJChcIi5mcnVpdC1zbGlkZXJcIikuZWFjaChmdW5jdGlvbihpLGUpe1xuICAgICAgICAgICAgdmFyIGFtb3VudD0kKGUpLmRhdGEoXCJzbGlkZXJcIikuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIGlmKGFtb3VudD4wKSB7XG4gICAgICAgICAgICAgICAgLy9LdW5zdGdyaWZmLiB2ZXJpbmdlcmUgV2VydGUgdW0gbWl0IGlkZW50aXNjaGVuIFdlcnRlbiBGYXJiZW4gc3BlaWNoZXJuIHp1IGvDtm5uZW5cbiAgICAgICAgICAgICAgICB3aGlsZShhbW91bnRzLmluZGV4T2YoYW1vdW50KSE9LTEpe1xuICAgICAgICAgICAgICAgICAgICBhbW91bnQtLTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYW1vdW50cy5wdXNoKGFtb3VudCk7XG4gICAgICAgICAgICAgICAgY29sb3JzW2Ftb3VudF0gPSAkKGUpLmF0dHIoXCJkYXRhLWNvbG9yXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYW1vdW50cy5zb3J0KCkucmV2ZXJzZSgpO1xuXG4gICAgICAgIHZhciBhbW91bnRzU3VtPTA7XG4gICAgICAgIGFtb3VudHMuZm9yRWFjaChmdW5jdGlvbihlKXtcblxuICAgICAgICAgICAgYW1vdW50c1N1bSs9ZTtcbiAgICAgICAgICAgIHZhciBuZXdFbGU9ZnJ1aXRDb2xvclRtcGwuY2xvbmUoKTtcbiAgICAgICAgICAgIG5ld0VsZS5jc3MoXCJoZWlnaHRcIixhbW91bnRzU3VtKjAuNzcrXCIlXCIpO1xuICAgICAgICAgICAgbmV3RWxlLmZpbmQoXCI+KlwiKS5jc3MoXCJiYWNrZ3JvdW5kQ29sb3JcIixjb2xvcnNbZV0pO1xuICAgICAgICAgICAgLy9lbnRmZXJuZSBGYXJid2VydCB1bSBrZWluZSBkb1xuICAgICAgICAgICAgd3JhcHBlci5wcmVwZW5kKG5ld0VsZSk7XG4gICAgICAgIH0pXG4gICAgfTtcbiAgICAvKipcbiAgICAgKiBTdGVsbHQgc2ljaGVyLCBkYXNzIGFsbGUgUmVnbGVyIGltbWVyIDEwMCUgZXJnZWJlbiFcbiAgICAgKi9cbiAgICB2YXIgYWRqdXN0U3VtPWZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciB2YWx1ZXM9W107XG4gICAgICAgICQoXCIuZnJ1aXQtc2xpZGVyXCIpLmVhY2goZnVuY3Rpb24oaSxlKXtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKCQoZSkuZGF0YShcInNsaWRlclwiKS5nZXRWYWx1ZSgpKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciBjaGFuZ2luZ1NsaWRlcj11bmRlZmluZWQ7XG4gICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGg+MCkge1xuICAgICAgICAgICAgY2hhbmdpbmdTbGlkZXIgPSBhcmd1bWVudHNbMF07XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHN1bT12YWx1ZXMuc3VtKCk7XG4gICAgICAgIGlmKHN1bT4xMDApe1xuICAgICAgICAgICAgdmFyIGRpZmY9c3VtLTEwMDtcbiAgICAgICAgICAgIHZhciBiaWdnZXN0PWdldEJpZ2dlc3RTbGlkZXIoY2hhbmdpbmdTbGlkZXIpO1xuICAgICAgICAgICAgdmFyIHZhbD1iaWdnZXN0LmRhdGEoXCJzbGlkZXJcIikuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIGJpZ2dlc3QuZGF0YShcInNsaWRlclwiKS5zZXRWYWx1ZSh2YWwtZGlmZik7XG4gICAgICAgICAgICBiaWdnZXN0LnZhbCh2YWwtZGlmZik7XG4gICAgICAgICAgICAkKCcjJyskKGJpZ2dlc3QpLmF0dHIoXCJkYXRhLXByZXZcIikpLnRleHQodmFsLWRpZmYpO1xuICAgICAgICB9XG4gICAgICAgIGNhbGNQcmljZSgpO1xuICAgICAgICBkcmF3TWl4ZXIoKTtcbiAgICB9O1xuICAgIC8qKlxuICAgICAqIEbDvGd0IEZydWNodCBpbiBGb3JtdWxhciBlaW5cbiAgICAgKi9cbiAgICB2YXIgYWRkRnJ1aXQ9ZnVuY3Rpb24oaWQsY29sb3IsbmFtZSxwcmljZSxwaWMpe1xuICAgICAgICBpZihpZD09dW5kZWZpbmVkKXtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZT0kKFwiI2FsbC1mcnVpdC1zbGlkZXJzPipcIikubGVuZ3RoPDE/MTAwOjA7XG5cbiAgICAgICAgdmFyIHNsaWRlVG1wbD0kKCc8ZGl2IGNsYXNzPVwicm93IGZydWl0LXNsaWRlLXJvd1wiIGRhdGEtZnJ1aXQtaWQ9XCInK2lkKydcIj4nICtcbiAgICAgICAgJzxpbWcgc3JjPVwiJytwaWMrJ1wiLz4nICtcbiAgICAgICAgJzxsYWJlbD48c3BhbiBpZD1cImZydWl0JytpZCsnXCIgY2xhc3M9XCJmcnVpdC12YWx1ZVwiPicrZGVmYXVsdFZhbHVlKyc8L3NwYW4+JytuYW1lKyc8L2xhYmVsPjxicj4nICtcbiAgICAgICAgJzxpbnB1dCBuYW1lPVwiZnJ1aXRJblNtb290aGllWycraWQrJ11cIiB0eXBlPVwidGV4dFwiIGRhdGEtY29sb3I9XCInK2NvbG9yKydcIiBkYXRhLXByaWNlPVwiJytwcmljZSsnXCIgY2xhc3M9XCJmcnVpdC1zbGlkZXJcIiBkYXRhLXByZXY9XCJmcnVpdCcraWQrJ1wiIGRhdGEtc2xpZGVyLXZhbHVlPVwiJytkZWZhdWx0VmFsdWUrJ1wiIC8+JyArXG4gICAgICAgICc8YnV0dG9uIGNsYXNzPVwiYnRuIGJ0bi1kYW5nZXIgcmVtb3ZlLWZydWl0XCIgPicgK1xuICAgICAgICAnPHNwYW4gY2xhc3M9XCJnbHlwaGljb24gZ2x5cGhpY29uLXJlbW92ZVwiIGFyaWEtaGlkZGVuPVwidHJ1ZVwiPjwvYnV0dG9uPjwvZGl2PicpO1xuXG4gICAgICAgIC8vZsO8Z2UgZWluXG4gICAgICAgICQoXCIjYWxsLWZydWl0LXNsaWRlcnNcIikuYXBwZW5kKHNsaWRlVG1wbCk7XG5cbiAgICAgICAgJChcIi5mcnVpdC1zbGlkZXJcIikudmFsKGRlZmF1bHRWYWx1ZSk7XG4gICAgICAgIGluaXRTbGlkZXJzKCk7XG4gICAgICAgIGFkanVzdFN1bSgpO1xuICAgICAgICBcbiAgICAgICAgJCgnW2RhdGEtcHJldj1cImZydWl0JytpZCsnXCJdJylcbiAgICAgICAgICAgIC5wYXJlbnRzKFwiLnNsaWRlclwiKVxuICAgICAgICAgICAgLmZpbmQoXCIuc2xpZGVyLXNlbGVjdGlvbiwgLnNsaWRlci1oYW5kbGVcIilcbiAgICAgICAgICAgIC5jc3MoXCJiYWNrZ3JvdW5kXCIsY29sb3IpO1xuXG5cbiAgICB9O1xuXG4gICAgJChcIiNidG4tYWRkLWZydWl0XCIpLm9uKFwiY2xpY2tcIixmdW5jdGlvbigpe1xuICAgICAgICB2YXIgbW9kYWxXaW5kb3c9JCgnLmluc2VydG5ld0ZydWl0Jyk7XG4gICAgICAgIHZhciBJRD1tb2RhbFdpbmRvdy5maW5kKFwic2VsZWN0XCIpLnZhbCgpO1xuICAgICAgICB2YXIgc2VsZWN0aW9uPW1vZGFsV2luZG93LmZpbmQoJ29wdGlvbltpZD1cIicrSUQrJ1wiXScpO1xuICAgICAgICB2YXIgY29sb3I9c2VsZWN0aW9uLmF0dHIoXCJkYXRhLWNvbG9yXCIpO1xuICAgICAgICB2YXIgcGljPXNlbGVjdGlvbi5hdHRyKFwiZGF0YS1waWNcIik7XG4gICAgICAgIHZhciBuYW1lPXNlbGVjdGlvbi5hdHRyKFwiZGF0YS1uYW1lXCIpO1xuICAgICAgICB2YXIgcHJpY2U9c2VsZWN0aW9uLmF0dHIoXCJkYXRhLXByaWNlXCIpO1xuICAgICAgICBhZGRGcnVpdChJRCxjb2xvcixuYW1lLHByaWNlLCBwaWMpO1xuICAgICAgICAvL0F1c3dhaGwgc3RlaHQgbmljaHQgbWVociB6dXIgVmVyZsO8Z3VuZ1xuICAgICAgICBzZWxlY3Rpb24ucHJvcChcImRpc2FibGVkXCIsXCJkaXNhYmxlZFwiKTtcbiAgICAgICAgbW9kYWxXaW5kb3cuZmluZChcInNlbGVjdFwiKS5zZWxlY3RwaWNrZXIoJ3JlbmRlcicpO1xuXG4gICAgICAgIG1vZGFsV2luZG93Lm1vZGFsKCdoaWRlJylcbiAgICB9KTtcblxuICAgIC8qKlxuICAgICAqIEzDtnNjaHQgZWluZSBGcnVjaHRcbiAgICAgKi9cbiAgICAkKGRvY3VtZW50KS5vbihcImNsaWNrXCIsXCIucmVtb3ZlLWZydWl0XCIsZnVuY3Rpb24oZSl7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdmFyIHJvdz0kKHRoaXMpLnBhcmVudHMoXCIuZnJ1aXQtc2xpZGUtcm93XCIpO1xuICAgICAgICB2YXIgSUQ9cm93LmF0dHIoXCJkYXRhLWZydWl0LWlkXCIpO1xuICAgICAgICB2YXIgbW9kYWxXaW5kb3c9JCgnLmluc2VydG5ld0ZydWl0Jyk7XG5cbiAgICAgICAgbW9kYWxXaW5kb3cuZmluZCgnb3B0aW9uW2lkPVwiJytJRCsnXCJdJykucmVtb3ZlQXR0cihcImRpc2FibGVkXCIpO1xuICAgICAgICBtb2RhbFdpbmRvdy5maW5kKFwic2VsZWN0XCIpLnNlbGVjdHBpY2tlcigncmVuZGVyJyk7XG4gICAgICAgICQodGhpcykucGFyZW50cyhcIi5mcnVpdC1zbGlkZS1yb3dcIikucmVtb3ZlKCk7XG4gICAgICAgIGFkanVzdFN1bSgpO1xuICAgIH0pO1xuXG4gICAgLy9XZW5uIHNpY2ggUHJlaXMgw6RuZGVydC4uXG4gICAgJChcIiNzaXplXCIpLm9uKFwiY2hhbmdlXCIsIGNhbGNQcmljZSk7XG5cbiAgICAkKHdpbmRvdykubG9hZChmdW5jdGlvbigpeyAvL2Vyc3QgbmFjaCBsYWRlbiBkZXIgQmlsZGVyXG4gICAgICAgIGluaXRTbGlkZXJzKCk7XG4gICAgICAgIC8vZXJtYWxpZ2VzIGVpbmbDvGdlbiBlaW5lciBGcnVjaHRcbiAgICAgICAgJCgnLmluc2VydG5ld0ZydWl0JykubW9kYWwoJ3Nob3cnKVxuICAgIH0pO1xuXG59KTtcblxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9